/*! snake 2014-01-09 */
!function(){function a(a){a&&a()}function b(a){this.fps=u.INIT_FPS,this.tick=a,this.paused=!1}function c(a,b){this.blocks=a,this.direction=DIRECTION_LEFT,this.directionChanged=!1,this.x=Math.ceil(this.blocks/2),this.y=Math.ceil(this.blocks/2),this.sections=[];for(var c=this.x+b-1;c>=this.x;c--)this.sections.push({x:c,y:this.y})}function d(a){if(a){var e=this;this.canvas=a,this.context=this.canvas.getContext("2d"),this.blocks=d.BLOCKS,this.block_size=this.canvas.width/this.blocks,console.log("blocks: "+this.blocks),console.log("canvas.width: "+this.canvas.width),console.log("block_size: "+this.block_size),this.snake=new c(this.blocks,5),this.foods=[],this.food=this.getFood(),this.scoreListener=null,this.status=d.INITIALIZED,this.failListener=null,this.timer=new b(function(){if(e.snake.move(),e.isCollision())return e.timer.pause(),e.fail(),void 0;if(e.snake.directionChanged=!1,e.snake.x==e.food.x&&e.snake.y==e.food.y){e.foods.push(e.food),e.foods.length%5===0&&e.timer.speedUp(),y.triggerScoreChanged.call(e),e.snake.sections.push({x:e.snake.x,y:e.snake.y});var a=e.getFood();if(!a)return e.fail();e.food=a}else e.snake.sections.shift(),e.snake.sections.push({x:e.snake.x,y:e.snake.y});e.triggerMoved()})}}function e(a){this.canvas=a,this.context=this.canvas.getContext("2d"),this.layers=[]}function f(){this.game=null}function g(){this.bg=null,this.sprite=null}function h(a){this.el=a,this.$el=$(a),this.$canvas=this.$el.find("canvas"),this.canvas=this.$canvas[0],_Controller.initRender.call(this),this.user=null,this.rounds=0}var i=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||a,j=Array.prototype,k=Object.prototype,l=j.slice,m=j.indexOf,n=j.forEach,o=k.hasOwnProperty,p=Object.keys,q={},r={};r.has=function(a,b){return o.call(a,b)},r.keys=p||function(a){if(a!==Object(a))throw new TypeError("Invalid object");var b=[];for(var c in a)r.has(a,c)&&b.push(c);return b},r.indexOf=function(a,b){if(null===a)return-1;var c=0,d=a.length;if(m&&a.indexOf===m)return a.indexOf(b);for(;d>c;c++)if(a[c]===b)return c;return-1},r.each=function(a,b,c){if(null!==a)if(n&&a.forEach===n)a.forEach(b,c);else if(a.length===+a.length){for(var d=0,e=a.length;e>d;d++)if(b.call(c,a[d],d,a)===q)return}else for(var f=r.keys(a),g=0;g<f.length;g++)if(b.call(c,a[f[g]],f[g],a)===breaker)return},r.extend=function(a){return r.each(l.call(arguments,1),function(b){if(b)for(var c in b)a[c]=b[c]}),a},r.bind=function(a,b){var c=l.call(arguments,2);return function(){a.apply(b,c.concat(l.call(arguments)))}},r.delay=function(a,b){return function(){var c=arguments;setTimeout(function(){b&&b.apply(this,c)},a)}},r.timeup=function(a,b,c){var d="doing",e="done",f="timeout",g=d;return setTimeout(function(){console.log("u.timeup onTimeup, status: ",g),g===d&&(g=f,c&&c())},a),function(){console.log("u.timeup callback, status: ",g),g===d&&(g=e,b&&b.apply(this,arguments))}},console=window.console||{},console.log=console.log||function(){},console.error=console.error||function(){};var s=function(){return s.get.apply(s,arguments)};s.utils={isArray:Array.isArray||function(a){return"[object Array]"===Object.prototype.toString.call(a)},isPlainObject:function(a){return!!a&&"[object Object]"===Object.prototype.toString.call(a)},toArray:function(a){return Array.prototype.slice.call(a)},getKeys:Object.keys||function(a){var b=[],c="";for(c in a)a.hasOwnProperty(c)&&b.push(c);return b},escape:function(a){return String(a).replace(/[,;"\\=\s%]/g,function(a){return encodeURIComponent(a)})},retrieve:function(a,b){return null==a?b:a}},s.defaults={},s.expiresMultiplier=86400,s.set=function(a,b,c){if(s.utils.isPlainObject(a))for(var d in a)a.hasOwnProperty(d)&&this.set(d,a[d],b);else{c=s.utils.isPlainObject(c)?c:{expires:c};var e=void 0!==c.expires?c.expires:this.defaults.expires||"",f=typeof e;"string"===f&&""!==e?e=new Date(e):"number"===f&&(e=new Date(+new Date+1e3*this.expiresMultiplier*e)),""!==e&&"toGMTString"in e&&(e=";expires="+e.toGMTString());var g=c.path||this.defaults.path;g=g?";path="+g:"";var h=c.domain||this.defaults.domain;h=h?";domain="+h:"";var i=c.secure||this.defaults.secure?";secure":"";document.cookie=s.utils.escape(a)+"="+s.utils.escape(b)+e+g+h+i}return this},s.remove=function(a){a=s.utils.isArray(a)?a:s.utils.toArray(arguments);for(var b=0,c=a.length;c>b;b++)this.set(a[b],"",-1);return this},s.empty=function(){return this.remove(s.utils.getKeys(this.all()))},s.get=function(a,b){b=b||void 0;var c=this.all();if(s.utils.isArray(a)){for(var d={},e=0,f=a.length;f>e;e++){var g=a[e];d[g]=s.utils.retrieve(c[g],b)}return d}return s.utils.retrieve(c[a],b)},s.all=function(){if(""===document.cookie)return{};for(var a=document.cookie.split("; "),b={},c=0,d=a.length;d>c;c++){var e=a[c].split("=");b[decodeURIComponent(e[0])]=decodeURIComponent(e[1])}return b},s.enabled=function(){if(navigator.cookieEnabled)return!0;var a="_"===s.set("_","_").get("_");return s.remove("_"),a};var t={NETWORK_ERROR:"network error",STATUS_ERROR:"status error",_handle:function(a){return function(b){return 1!=b.status?a(t.STATUS_ERROR):(a(null,b.data),void 0)}},_onerror:function(a){return function(){a(t.NETWORK_ERROR)}},addScore:function(a,b){$.get("/game/api/addScore",a,"json").success(t._handle(b)).error(t._onerror(b))},getTotalScore:function(a,b){$.get("/game/api/getTotalScore",{member_id:a},"json").success(t._handle(b)).error(t._onerror(b))},getUserinfo:function(a){$.get("/game/api/getMemberInfo",{},"json").success(t._handle(a)).error(t._onerror(a))},getRank:function(a,b){$.get("/game/api/getScoreRank",{member_id:a},"json").success(t._handle(b)).error(t._onerror(b))},getInfoInNeed:function(a){function b(a){t.getUserinfo(function(b,c){return b?a(b):(a(null,c),void 0)})}function c(a,b){t.getRank(a.member_id,function(c,d){c||r.extend(a,d),b(null,a)})}async.waterfall([b,c],function(b,c){return b?a(b):(a(null,c),void 0)})},sync_score:function(a,b,c){function d(c){t.addScore({member_id:a,score:b},function(a,b){return a?c(a):(c(null,b.winPrize),void 0)})}function e(a,b){t.getUserinfo(function(c,d){return c?b(c):(d.winPrize=a,b(null,d),void 0)})}function f(b,c){t.getRank(a,function(a,d){a||r.extend(b,d),c(null,b)})}async.waterfall([d,e,f],function(a,b){return a?c(a):(c(null,b),void 0)})}},u={INIT_FPS:4};b.prototype={constructor:b,start:function(){this.paused=!1,this.count()},count:function(){var a=this;setTimeout(function(){a.paused||(a.tick(),a.count())},1e3/this.fps)},pause:function(){this.paused=!0},speedUp:function(){this.fps<60&&this.fps++}};var v={foodImage:null,foodSprites:null,snakeImage:null,snakeSprites:null,canvasImage:null,canvasSprites:null,user:null,loadGameSpriteImages:function(a){var b=["images/snake.png","images/foods.png","images/canvas.png"];async.each(b,function(a,b){var c=new Image;c.onload=function(){switch(a){case"images/snake.png":v.snakeImage=c;break;case"images/foods.png":v.foodImage=c;break;case"images/canvas.png":v.canvasImage=c}b(null)},c.onerror=function(){b("fail to load sprite image "+a)},c.src=a},function(b,c){return b?a(b):(a(null,c),void 0)})},loadGameSpriteMeta:function(a){async.each(["json/snake.json","json/foods.json","json/canvas.json"],function(a,b){$.get(a,"json").success(function(c){switch(a){case"json/snake.json":v.snakeSprites=c;break;case"json/foods.json":v.foodSprites=c;break;case"json/canvas.json":v.canvasSprites=c}b(null,c)}).error(function(){b("fail to load sprites: "+a)})},function(b,c){return b?a(b):(a(null,c),void 0)})},getInfoInNeed:function(a){t.getInfoInNeed(function(b,c){b||(v.user=c),a(null)})},loadResImages:function(a){var b=new Image;b.onload=function(){a(null,b)},b.onerror=function(){a("fail to load image:"+src)},b.src="images/resources.png"}};DIRECTION_LEFT="left",DIRECTION_RIGHT="right",DIRECTION_UP="up",DIRECTION_DOWN="down";var w={foods:{food1:{key:"food1",name:"food1"},food2:{key:"food2",name:"food2"},food3:{key:"food3",name:"food3"},food4:{key:"food4",name:"food4"},food5:{key:"food5",name:"food5"},food6:{key:"food6",name:"food6"},food7:{key:"food7",name:"food7"},food8:{key:"food8",name:"food8"},food9:{key:"food9",name:"food9"},food10:{key:"food10",name:"food10"},food11:{key:"food11",name:"food11"},food12:{key:"food12",name:"food12"},food13:{key:"food13",name:"food13"},food14:{key:"food14",name:"food14"}}},x={getFood:function(){var a=r.keys(w.foods);if(0===a.length)return null;var b=Math.floor(Math.random()*a.length);return w.foods[a[b]]}};INVERSE_DIRECTION={up:DIRECTION_DOWN,left:DIRECTION_RIGHT,right:DIRECTION_LEFT,down:DIRECTION_UP},c.prototype={section:function(a){var b=(this.sections.length+a)%this.sections.length;return this.sections[b]},length:function(){return this.sections.length},changeDirection:function(a){this.directionChanged||a!==INVERSE_DIRECTION[this.direction]&&(this.direction=a,this.directionChanged=!0)},bumpSelf:function(){return this.onBody(this.x,this.y)},onBody:function(a,b){for(var c=1;c<this.sections.length;c++){var d=this.sections[c];if(d.x===a&&d.y===b)return!0}return!1},directionOfSection:function(a){var b,c,d=this.sections.length,e=(d+a)%d;e==d-1?(b=this.section(e),c=this.section(e-1)):(c=this.section(e),b=this.section(e+1));var f;return f=b.x===c.x?b.y===c.y-1?DIRECTION_UP:DIRECTION_DOWN:b.x===c.x-1?DIRECTION_LEFT:DIRECTION_RIGHT},move:function(){switch(this.direction){case DIRECTION_UP:this.y--;break;case DIRECTION_DOWN:this.y++;break;case DIRECTION_LEFT:this.x--;break;default:this.x++}}};var y={DEFAULT_SCORE:10,triggerScoreChanged:function(){this.scoreListener&&this.scoreListener()}};r.extend(d,{BLOCKS:10,INITIALIZED:"initialized",PLAYING:"playing",PAUSED:"paused",OVER:"over"}),d.prototype={contructor:d,isInitialized:function(){return this.status===d.INITIALIZED},isOver:function(){return this.status===d.OVER},over:function(){this.status=d.OVER},start:function(){return this.status!==d.INITIALIZED&&this.status!==d.PAUSED?(console.error("wrong status"),void 0):(this.status=d.PLAYING,this.timer.start(),void 0)},pause:function(){this.timer.pause(),this.status=d.PAUSED},fail:function(){this.status=d.OVER,this.failListener&&this.failListener()},onFailed:function(a){this.failListener=a},onMoved:function(a){this.moveHanlder=a},triggerMoved:function(){this.moveHanlder&&this.moveHanlder()},isCollision:function(){return this.snake.x<0||this.snake.x>=this.blocks||this.snake.y<0||this.snake.y>=this.blocks?!0:this.snake.bumpSelf()},resetCanvas:function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)},score:function(){var a=0;return r.each(this.foods,function(b){a+=b.score}),a},onScoreChanged:function(a){this.scoreListener=a},getRect:function(a){return{x:a.x*this.block_size,y:a.y*this.block_size,width:this.block_size,height:this.block_size}},changeSnakeDirection:function(a){this.snake.changeDirection(a)},getFood:function(){if(this.snake.sections.length===this.blocks*this.blocks)return null;var a=x.getFood(),b=this.getNewFoodPosition();return r.extend({},a,b,{score:a.score||y.DEFAULT_SCORE})},getNewFoodPosition:function(){var a={};do a.x=Math.floor(Math.random()*this.blocks),a.y=Math.floor(Math.random()*this.blocks);while(this.snake.onBody(a.x,a.y));return a}},e.prototype={constructor:e,addLayer:function(a){this.layers.push(a)},removeLayer:function(a){~r.indexOf(this.layers,a)&&this.layers.remove(a)},draw:function(){var a=this;i(function(){a.resetCanvas();for(var b=0;b<a.layers.length;b++)a.layers[b].draw(a)})},resetCanvas:function(){var a=this.canvas,b=this.context;b.clearRect(0,0,a.width,a.height)},drawImage:function(a,b,c){var d=this.context;d.drawImage(a,b.x,b.y,b.width,b.height,c.x,c.y,c.width,c.height)}},f.prototype={constructor:f,setGame:function(a){this.game=a},draw:function(a){var b=this.game;if(b){var c=b.snake,d=c.section(-1),e=c.directionOfSection(-1),f=v.snakeSprites["animal_head_"+e];a.drawImage(v.snakeImage,f,b.getRect(d)),f=v.snakeSprites.animal_body_nian;for(var g=1;g<c.length()-1;g++){var h=c.section(g);a.drawImage(v.snakeImage,f,b.getRect(h))}var i=c.section(0);e=c.directionOfSection(0),f=v.snakeSprites["animal_tail_"+e],a.drawImage(v.snakeImage,f,b.getRect(i));var j=b.food;f=v.foodSprites[j.key],a.drawImage(v.foodImage,f,b.getRect(j))}}},g.prototype={constructor:g,draw:function(a){var b=this.bg,c=this.sprite;if(b&&c){var d={x:0,y:0,width:a.canvas.width,height:a.canvas.height};a.drawImage(b,c,d)}}},_Controller={setupKeyBindings:function(){function a(a){return function(){b.game.status===d.PLAYING&&a&&a.apply(this,arguments)}}var b=this,c=$(document).hammer();c.on("touchmove",a(function(a){a.preventDefault()})).on("swipeup, dragup",a(function(a){a.preventDefault(),b.game.changeSnakeDirection("up")})).on("swipedow dragdown",a(function(a){a.preventDefault(),b.game.changeSnakeDirection("down")})).on("swipeleft dragleft",a(function(a){a.preventDefault(),b.game.changeSnakeDirection("left")})).on("swiperight dragright",a(function(a){a.preventDefault(),b.game.changeSnakeDirection("right")}))},onScoreChanged:function(){this.$currentScore.html(this.game.score())},onUploadScoreFailed:function(){console.error("failed to upload score")},onScoreUploaded:function(a){this.user=a,this.$totalScore.html(a.score),_Controller.showInfo.call(this)},onUploadScoreTimeout:function(){_Controller.onUploadScoreFailed.call(this)},onGameFailed:function(){function a(a){return function(){a&&a.apply(null,arguments)}}var b=this;this.$control.removeClass("pause"),this.game.over(),t.sync_score(this.user.member_id,this.game.score(),r.timeup(1e4,a(function(a,c){a?_Controller.onUploadScoreFailed.call(b):_Controller.onScoreUploaded.call(b,c)}),a(r.bind(_Controller.onUploadScoreTimeout,this))))},loading:function(){this.context},newGame:function(){this.game=new d(this.canvas),this.game.onMoved(r.bind(this.render.draw,this.render)),this.game.onScoreChanged(r.bind(_Controller.onScoreChanged,this)),this.game.onFailed(r.bind(_Controller.onGameFailed,this))},kickOff:function(){this.$currentScore.html(0),this.rounds++},resume:function(){this.game.start(),this.$control.addClass("pause")},pause:function(){this.game.pause(),this.$control.removeClass("pause")},startGame:function(){_Controller.newGame.call(this),_Controller.kickOff.call(this),_Controller.resume.call(this),window.scrollTo(0,0),this.el.scrollIntoView(!0),this.gameLayer.setGame(this.game),this.render.draw()},initRender:function(){this.render=new e(this.canvas),this.gameLayer=new f,this.bgLayer=new g,this.render.addLayer(this.bgLayer),this.render.addLayer(this.gameLayer)},showInfo:function(){this.$currentScore.html("0"),this.$totalScore.html(this.user.score)}},r.extend(h.prototype,{onload:function(a){function b(){var a=Math.min(window.innerWidth,window.innerHeight),b=c.$controlbar.outerHeight();a-=b,c.$canvas.css("width",a+"px"),c.$canvas.css("height",a+"px"),c.render.draw()}var c=this;return this.user=a,this.bgLayer.bg=v.canvasImage,this.bgLayer.sprite=v.canvasSprites.canvas_bg,this.render.draw(),a?(this.$controlbar=this.$el.find(".header"),window.onresize=b,b(),this.$currentScore=this.$el.find(".current.score"),this.$totalScore=this.$el.find(".total.score"),_Controller.showInfo.call(this),this.$control=this.$el.find(".control"),this.$control.click(function(){if(!c.game)return _Controller.startGame.call(c);switch(c.game.status){case d.OVER:_Controller.startGame.call(c);break;case d.PAUSED:_Controller.resume.call(c);break;case d.PLAYING:_Controller.pause.call(c);break;default:console.error("invlaid status",c.game.status)}}),_Controller.setupKeyBindings.call(this),void 0):(this.$control.click(function(){}),void 0)}}),$(function(){var a=new h($(".snake-container-wrap")[0]);async.parallel([v.loadGameSpriteMeta,v.loadGameSpriteImages,v.getInfoInNeed],function(b){return b?console.error(b):(a.onload(v.user),void 0)})})}();